<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Language Encoding Compile - Podevus</title>
    <link rel="icon" type="image/x-icon" href="../logo.ico">
    <script src="https://unpkg.com/@waline/client@v3/dist/waline.js"></script>
    <style>
:root {
    --primary-bg: #faf8f3;
    --secondary-bg: #f5f1e8;
    --accent-color: #c89b6d;
    --accent-hover: #a67c52;
    --text-primary: #2d2520;
    --text-secondary: #5a504a;
    --text-muted: #8b7f76;
    --border-light: #e8dfd2;
    --border-dark: #d4c4b0;
    --shadow-color: rgba(45, 37, 32, 0.08);
    --card-bg: #ffffff;
    --comment-bg-start: #2c1810;
    --comment-bg-end: #1a0f0a;
    --comment-text: #f5e6d3;
    --comment-border: #8b5a2b;
    --comment-accent: #c89b6d;
    --font-serif: "Noto Serif JP", "Source Han Serif CN", Georgia, serif;
    --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
}
@media (prefers-color-scheme: dark) {
    :root {
        --primary-bg: #1a1816;
        --secondary-bg: #242220;
        --accent-color: #d4a574;
        --accent-hover: #e6b786;
        --text-primary: #e8e6e3;
        --text-secondary: #c4bfb8;
        --text-muted: #8b8580;
        --border-light: #3a3633;
        --border-dark: #4a4440;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --card-bg: #242220;
    }
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: var(--font-sans);
    line-height: 1.8;
    color: var(--text-primary);
    background: var(--primary-bg);
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    transition: background-color 0.05s linear;
}
body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, var(--shadow-color) 2px, var(--shadow-color) 4px);
    opacity: 0.03;
    pointer-events: none;
    z-index: -1;
}
header {
    border-bottom: 2px solid var(--border-dark);
    padding-bottom: 30px;
    margin-bottom: 50px;
    position: relative;
}
header::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 120px;
    height: 2px;
    background: var(--accent-color);
    transition: width 0.5s ease;
}
header:hover::after { width: 200px; }
h1 {
    font-family: var(--font-serif);
    font-size: 2.5em;
    font-weight: 500;
    margin-bottom: 12px;
    color: var(--text-primary);
}
h1 a { color: inherit; text-decoration: none; position: relative; }
h1 a::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0; right: 0;
    height: 1px;
    background: var(--accent-color);
    transform: scaleX(0);
    transform-origin: right;
    transition: transform 0.3s ease;
}
h1 a:hover::after { transform: scaleX(1); transform-origin: left; }
.subtitle {
    font-family: var(--font-serif);
    font-size: 1.15em;
    color: var(--text-secondary);
    letter-spacing: 0.3em;
}
nav {
    margin-top: 25px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px 30px;
}
nav a {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.95em;
    position: relative;
    padding: 5px 0;
    transition: color 0.3s ease;
}
nav a::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0; right: 0;
    height: 1px;
    background: var(--accent-color);
    transform: scaleX(0);
    transform-origin: right;
    transition: transform 0.3s ease;
}
nav a:hover { color: var(--accent-color); }
nav a:hover::before { transform: scaleX(1); transform-origin: left; }
.article-header { margin-bottom: 40px; }
.article-title {
    font-family: var(--font-serif);
    font-size: 2em;
    font-weight: 700;
    margin-bottom: 15px;
    color: var(--text-primary);
}
.article-subtitle {
    font-size: 1.3em;
    margin-bottom: 10px;
    color: var(--text-primary);
}
.article-meta {
    font-size: 0.9em;
    color: var(--text-muted);
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-light);
}
.article-meta span { margin-right: 15px; }
.post-category {
    display: inline-block;
    background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
    color: #fff;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 0.85em;
    text-decoration: none;
    font-weight: 500;
}
.article-content {
    font-size: 1.05em;
    line-height: 1.9;
    color: var(--text-secondary);
}
.article-content p { margin-bottom: 1.5em; }
.article-content h3 {
    font-family: var(--font-serif);
    font-size: 1.25em;
    font-weight: 600;
    margin-top: 1.8em;
    margin-bottom: 0.8em;
    color: var(--accent-color);
}
.error {
    color: #fff;
    background-color: #d32f2f;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 4px;
}
.back-link {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid var(--border-light);
}
.back-link a {
    color: var(--accent-color);
    text-decoration: none;
    font-size: 0.95em;
    margin-right: 20px;
}
.back-link a:hover { color: var(--accent-hover); }
footer {
    margin-top: 0;
    padding: 30px 0;
    border-top: 2px solid var(--border-dark);
    text-align: center;
    color: var(--text-muted);
    font-size: 0.9em;
    position: relative;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    background: transparent;
}
footer::before {
    content: '';
    position: absolute;
    top: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 2px;
    background: var(--accent-color);
}
.comments-gradient-wrapper {
    position: relative;
    margin-top: 60px;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    padding: 120px 20px 100px;
    overflow: visible;
    background: transparent;
    min-height: 100vh;
}
.particles-background, .particles-foreground {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    overflow: hidden;
}
.particles-background { z-index: 0; }
.particles-foreground { z-index: 10; }
.particle {
    position: absolute;
    bottom: -20px;
    background: radial-gradient(circle, rgba(200, 155, 109, 0.8), rgba(200, 155, 109, 0) 70%);
    border-radius: 50%;
    pointer-events: none;
    animation: floatUp linear infinite;
    box-shadow: 0 0 10px rgba(200, 155, 109, 0.5);
}
.particles-foreground .particle { filter: blur(1px); opacity: 0.6; }
@keyframes floatUp {
    0% { transform: translateY(0) translateX(0) scale(0.5); opacity: 0; }
    5% { opacity: 1; }
    95% { opacity: 1; }
    100% { transform: translateY(-120vh) translateX(var(--drift)) scale(1); opacity: 0; }
}
.steampunk-comments {
    max-width: 900px;
    margin: 0 auto;
    position: relative;
    z-index: 5;
    padding: 120px 20px 100px;
    opacity: 0;
    transform: translateY(50px);
}
.section-title {
    font-family: var(--font-serif);
    font-size: 1.8em;
    color: var(--comment-accent);
    margin-bottom: 30px;
    text-align: center;
    position: relative;
    padding-bottom: 15px;
}
.section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--comment-accent), transparent);
}
.comments-count {
    text-align: center;
    color: var(--comment-text);
    opacity: 0.7;
    font-size: 0.9em;
    margin-bottom: 25px;
}
.comments-loading {
    text-align: center;
    color: var(--comment-text);
    opacity: 0.7;
    padding: 40px 20px;
}
.comments-loading::after {
    content: '';
    display: inline-block;
    width: 20px; height: 20px;
    border: 2px solid var(--comment-accent);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
    vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }
.comment-card {
    background: rgba(44, 24, 16, 0.4);
    margin-bottom: 20px;
    padding: 25px;
    position: relative;
    clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 15px 100%, 0 calc(100% - 15px));
    border: 1px solid var(--comment-border);
    transition: all 0.3s ease;
}
.comment-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, rgba(200, 155, 109, 0.05), transparent 50%, rgba(200, 155, 109, 0.03));
    pointer-events: none;
}
.comment-card::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 15px; height: 15px;
    background: linear-gradient(135deg, var(--comment-border), transparent);
    clip-path: polygon(0 0, 100% 0, 100% 100%);
}
.comment-card:hover {
    transform: translateX(5px);
    border-color: var(--comment-accent);
    box-shadow: -5px 0 15px rgba(200, 155, 109, 0.2);
}
.comment-replies {
    margin-left: 40px;
    margin-top: 15px;
    padding-left: 20px;
    border-left: 2px solid rgba(200, 155, 109, 0.3);
}
.comment-replies .comment-card {
    background: rgba(44, 24, 16, 0.25);
    padding: 20px;
    margin-bottom: 15px;
}
.comment-replies .comment-replies { margin-left: 30px; }
.comment-avatar {
    width: 45px; height: 45px;
    border-radius: 50%;
    border: 2px solid var(--comment-accent);
    overflow: hidden;
    flex-shrink: 0;
}
.comment-avatar img { width: 100%; height: 100%; object-fit: cover; }
.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 1px dashed rgba(139, 90, 43, 0.3);
    gap: 15px;
}
.comment-header-left { display: flex; align-items: center; gap: 12px; }
.comment-author-info { display: flex; flex-direction: column; gap: 3px; }
.comment-author {
    color: var(--comment-accent);
    font-weight: 600;
    font-size: 1.05em;
    display: flex;
    align-items: center;
    gap: 8px;
}
.comment-author::before { content: '⚙'; color: var(--comment-accent); font-size: 0.9em; }
.comment-author a { color: var(--comment-accent); text-decoration: none; }
.comment-author a:hover { color: #e6b786; text-decoration: underline; }
.comment-time { color: var(--comment-text); opacity: 0.6; font-size: 0.85em; font-family: 'Courier New', monospace; }
.comment-time a { color: inherit; text-decoration: none; }
.comment-time a:hover { color: var(--comment-accent); }
.comment-content { color: var(--comment-text); line-height: 1.8; margin-bottom: 12px; }
.reply-to-indicator { color: var(--comment-accent); font-size: 0.9em; margin-bottom: 8px; opacity: 0.8; }
.reply-to-indicator span { font-weight: 600; }
.comment-footer { display: flex; justify-content: flex-end; }
.reply-btn {
    background: transparent;
    border: 1px solid var(--comment-border);
    color: var(--comment-accent);
    padding: 5px 15px;
    font-size: 0.85em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
.reply-btn::before { content: '↩'; }
.reply-btn:hover {
    background: rgba(200, 155, 109, 0.2);
    border-color: var(--comment-accent);
    transform: translateY(-1px);
}
.no-comments {
    text-align: center;
    color: var(--comment-text);
    opacity: 0.5;
    padding: 60px 20px;
    font-size: 1.1em;
}
.comment-form-section {
    background: rgba(44, 24, 16, 0.3);
    padding: 35px;
    position: relative;
    clip-path: polygon(15px 0, calc(100% - 15px) 0, 100% 15px, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px), 0 15px);
    border: 2px solid var(--comment-accent);
}
.comment-form-section::before, .comment-form-section::after {
    content: '';
    position: absolute;
    width: 20px; height: 20px;
    border: 2px solid var(--comment-accent);
}
.comment-form-section::before { top: -2px; left: -2px; border-right: none; border-bottom: none; }
.comment-form-section::after { bottom: -2px; right: -2px; border-left: none; border-top: none; }
.form-title {
    font-family: var(--font-serif);
    font-size: 1.6em;
    color: var(--comment-accent);
    margin-bottom: 25px;
    text-align: center;
}
.reply-notice {
    background: rgba(200, 155, 109, 0.15);
    border: 1px solid var(--comment-border);
    padding: 12px 18px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 4px;
}
.reply-notice.hidden { display: none; }
.reply-notice-text { color: var(--comment-text); font-size: 0.95em; }
.reply-notice-text span { color: var(--comment-accent); font-weight: 600; }
.cancel-reply-btn {
    background: transparent;
    border: 1px solid #b43232;
    color: #ff8888;
    padding: 4px 12px;
    font-size: 0.85em;
    cursor: pointer;
}
.cancel-reply-btn:hover { background: rgba(180, 50, 50, 0.2); }
.form-row-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}
.form-group { display: flex; flex-direction: column; gap: 10px; }
.form-group label { color: var(--comment-accent); font-size: 0.95em; font-weight: 500; padding-left: 5px; }
.form-group label .optional { color: var(--comment-text); opacity: 0.5; font-weight: 400; font-size: 0.85em; }
.form-group input {
    background: rgba(26, 15, 10, 0.6);
    border: 1px solid var(--comment-border);
    border-left: 3px solid var(--comment-accent);
    padding: 12px 15px;
    color: var(--comment-text);
    font-size: 0.95em;
    font-family: inherit;
    transition: all 0.3s ease;
}
.form-group input:focus {
    outline: none;
    border-color: var(--comment-accent);
    box-shadow: 0 0 10px rgba(200, 155, 109, 0.3);
    background: rgba(26, 15, 10, 0.8);
}
.comment-textarea {
    width: 100%;
    min-height: 130px;
    background: rgba(26, 15, 10, 0.6);
    border: 1px solid var(--comment-border);
    border-left: 3px solid var(--comment-accent);
    padding: 15px;
    color: var(--comment-text);
    font-size: 0.95em;
    font-family: inherit;
    resize: vertical;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}
.comment-textarea:focus {
    outline: none;
    border-color: var(--comment-accent);
    box-shadow: 0 0 10px rgba(200, 155, 109, 0.3);
    background: rgba(26, 15, 10, 0.8);
}
.notify-options { margin-bottom: 20px; }
.notify-option {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--comment-text);
    font-size: 0.9em;
    opacity: 0.8;
    cursor: pointer;
}
.notify-option input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--comment-accent); cursor: pointer; }
.submit-btn {
    background: linear-gradient(135deg, var(--comment-accent), #a67c52);
    border: 2px solid var(--comment-accent);
    padding: 12px 40px;
    color: #1a0f0a;
    font-size: 1.05em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
}
.submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(200, 155, 109, 0.4); }
.submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
.message { margin-top: 15px; padding: 12px 20px; border-left: 3px solid; font-size: 0.9em; }
.message.error { background: rgba(180, 50, 50, 0.2); border-color: #b43232; color: #ff8888; }
.message.success { background: rgba(80, 180, 100, 0.2); border-color: #50b464; color: #88ffaa; }
.hidden { display: none; }
@media (max-width: 768px) {
    body { padding: 18px; }
    h1 { font-size: 2em; }
    .form-row-3 { grid-template-columns: 1fr; }
    .comment-replies { margin-left: 15px; padding-left: 10px; }
    .comment-avatar { width: 35px; height: 35px; }
    .comment-header { flex-direction: column; gap: 10px; }
    .reply-notice { flex-direction: column; gap: 10px; text-align: center; }
}
html { scroll-behavior: smooth; }
::selection { background: var(--accent-color); color: #fff; }
    </style>
</head>
<body>
    <header>
        <h1><a href="../index.html">Podevus</a></h1>
        <p class="subtitle">記 · 思 · 道</p>
        <nav>
            <a href="../index.html">首页</a>
            <a href="../category/Blog_category_tech.html">技术</a>
            <a href="../category/Blog_category_reading.html">读书</a>
            <a href="../category/Blog_category_anime.html">幻想</a>
            <a href="../category/Blog_category_thinking.html">思考</a>
            <a href="../Blog_about.html">关于</a>
        </nav>
    </header>

    <article>
        <div class="article-header">
            <h1 class="article-title">Game Language Encoding Compile</h1>
            <h2 class="article-subtitle">Capstone Project</h2>
            <div class="article-meta">
                <a href="../category/Blog_category_tech.html" class="post-category">技术</a>
                <span>2025年11月29日起更新</span>
                <span>阅读时间: 不计算</span>
            </div>
        </div>

        <div class="article-content">
            <p>这是一篇Capstone Project相关的<strong>开发日志</strong><br>
                在这里记录关于日语环境编码、工作进程、开发工具使用等方面的内容。</p>

            <h3>2025/09/26</h3>
            <p>确定项目</p>

            <h3>2025/09/27</h3>
            <p>深入学习日语编码环境的技术细节，包括Shift-JIS和UTF-8编码系统的转换机制，同时系统性研究AVE Engine的底层运作原理、文件结构和脚本解析逻辑</p>
            <p>开始初步搭建Podevus个人博客网站，经过多次设计迭代后确定了整体的视觉风格和技术架构，完成了主页的HTML结构搭建和CSS样式设计，实现了基础的响应式布局</p>

            <h3>2025/10/05</h3>
            <p>经过深入的技术调研和可行性分析，决定将项目主体引擎更换，主要原因是AVE Engine的文档资料相对匮乏且社区支持有限，最终放弃AVE转而采用更成熟、文档更完善的Siglus Engine作为新的技术方向</p>

            <h3>2025/10/18</h3>
            <p>系统学习Siglus Extract工具的使用方法和命令行参数，深入研究其衍生解包器的工作原理，包括文件格式识别、资源提取流程以及各类封包格式的解析技术</p>

            <h3>2025/10/25</h3>
            <p>进行了第一次完整的游戏资源解包操作，成功提取了游戏的脚本文件、图像资源和音频素材</p>
            <p class="error">问题1：第一次执行解码操作时，解包工具被Windows Defender误判为恶意软件，程序被自动隔离</p>
            <p>通过将解包工具添加到Windows Defender的排除列表中，并验证了文件的数字签名，成功解决了杀毒软件的误报问题，确保了后续工作的顺利进行</p>

            <h3>2025/10/26</h3>
            <p>完成游戏图片资源的批量解包工作，并进行了细致的分类整理，通过人工筛选和图像识别技术相结合，准确区分出所有包含日文文字、需要进行本地化翻译和重新制作的UI图片素材</p>

            <h3>2025/11/01</h3>
            <p>对游戏的用户界面文本和第一章完整剧情内容进行了初步翻译工作，包括粗翻、语境校订以及文学性的精修润色，确保译文既准确传达原意又符合中文的表达习惯和阅读体验</p>

            <h3>2025/11/15</h3>
            <p>将第一章翻译完成的文本内容和修订重制好的本地化图片资源进行了完整的封装测试，测试结果显示所有内容均能正常加载和显示</p>
            <p>使用Siglus Engine的打包工具将修改后的资源重新加密压缩为.pck格式的封包文件,并在游戏环境中进行了多轮实际运行测试，验证了文本显示、图片渲染和交互功能均无异常，未出现乱码、错位或其他显示问题</p>

            <h3>2025/11/16</h3>
            <p>启动了Podevus个人博客网站的全面完善和功能扩展工作，开始设计和开发更多的内容模块和交互特性</p>

            <h3>2025/11/23</h3>
            <p>本周集中完善了网站的6个核心内容承载页面，包括页面布局优化、内容展示逻辑改进和视觉效果提升，同时还开发制作了两个功能性测试页面用于验证新特性和交互设计的可行性</p>

            <h3>2025/11/30</h3>
            <p>本周设计并绘画/JS程序制作了Podevus的光标显示效果，分别为全局通用和プリマドール相关内容专用的两种。<br>
            全局通用光标秉承了整个网站的设计风格-简洁的大正浪漫风配色，米白+古铜金+深棕+暖灰的基本色调；<br>
            プリマドール相关内容专用光标的配色选取了鴉羽衣服的两种主要颜色，并加入了随移动速度加快的自旋效果</p>

            <h3>2025/12/07</h3>
            <p>增加了Podevus网站光标悬停在可交互内容上时浮现的阴影，为Capstone Log页面增加了独特光标效果</p>
            <p>    未定    </p>
        </div>

        <div class="back-link">
            <a href="../index.html">← 返回首页</a>
            <a href="../category/Blog_category_tech.html">查看更多技术文章</a>
        </div>
    </article>

    <div class="comments-gradient-wrapper" id="commentsSection">
        <div class="particles-background" id="particlesBackground"></div>
        <div class="steampunk-comments">
            <div class="comments-history-section">
                <h2 class="section-title">Comments</h2>
                <div class="comments-count" id="commentsCount">0 Replies</div>
                <div id="commentsList">
                    <div class="comments-loading">Loading comments...</div>
                </div>
            </div>
            <div class="comment-form-section" id="respond">
                <h3 class="form-title">Leave a Reply</h3>
                <div class="reply-notice hidden" id="replyNotice">
                    <span class="reply-notice-text">Replying to <span id="replyToName"></span>'s comment</span>
                    <button type="button" class="cancel-reply-btn" id="cancelReplyBtn">Cancel reply</button>
                </div>
                <form id="commentForm">
                    <input type="hidden" id="replyToId" value="">
                    <input type="hidden" id="replyToAuthor" value="">
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="nameInput">Name *</label>
                            <input type="text" id="nameInput" placeholder="Enter your name" required>
                        </div>
                        <div class="form-group">
                            <label for="emailInput">Email *</label>
                            <input type="email" id="emailInput" placeholder="Email (will not be published)" required>
                        </div>
                        <div class="form-group">
                            <label for="websiteInput">Website <span class="optional">(optional)</span></label>
                            <input type="url" id="websiteInput" placeholder="https://your-website.com">
                        </div>
                    </div>
                    <textarea class="comment-textarea" id="commentTextarea" placeholder="Share your thoughts..." required></textarea>
                    <div class="notify-options">
                        <label class="notify-option">
                            <input type="checkbox" id="notifyReplies">
                            <span>Notify me of follow-up replies by email.</span>
                        </label>
                    </div>
                    <button type="submit" class="submit-btn" id="submitBtn">Post Comment</button>
                    <div id="formMessage" class="hidden"></div>
                </form>
            </div>
        </div>
        <div class="particles-foreground" id="particlesForeground"></div>
    </div>

    <footer>
        <p>© 2025 Podevus</p>
        <p style="margin-top: 10px; font-size: 0.85em;">存质</p>
    </footer>

    <script>
// [FIX] 使用完整URL作为path，与Waline后台一致
const WALINE_SERVER_URL = 'https://podevuscomments.vercel.app';
const PAGE_PATH = 'https://podevei.github.io/Podevus/posts/CapLog.html';

console.log('[Init] Waline Config Loaded.');
console.log('[Init] Active Path:', PAGE_PATH);

// 滚动触发背景变色和评论显示
(function() {
    const commentsContent = document.querySelector('.steampunk-comments');
    const backLink = document.querySelector('.back-link');
    const footer = document.querySelector('footer');
    let triggerScrollTop = 0;
    let hasTriggered = false;
    const COLOR_CHANGE_RANGE = 400;
    const COMMENT_SHOW_RANGE = 300;

    function updateBodyBackgroundColor(progress) {
        const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let startR, startG, startB;
        if (isDark) { startR = 26; startG = 24; startB = 22; }
        else { startR = 250; startG = 248; startB = 243; }
        const endR = 44, endG = 24, endB = 16;
        const r = Math.round(startR + (endR - startR) * progress);
        const g = Math.round(startG + (endG - startG) * progress);
        const b = Math.round(startB + (endB - startB) * progress);
        document.body.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
        footer.style.color = r < 128 ? '#f5e6d3' : '#8b7f76';
    }

    function showComments(progress) {
        commentsContent.style.opacity = Math.min(1, progress);
        commentsContent.style.transform = `translateY(${Math.max(0, 50 * (1 - progress))}px)`;
    }

    function handleScroll() {
        const rect = backLink.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        const currentScrollTop = window.pageYOffset;
        const isBackLinkVisible = rect.bottom <= windowHeight;
        if (isBackLinkVisible && !hasTriggered) { triggerScrollTop = currentScrollTop; hasTriggered = true; }
        if (!hasTriggered) { updateBodyBackgroundColor(0); showComments(0); return; }
        const scrollDistance = currentScrollTop - triggerScrollTop;
        if (scrollDistance <= COLOR_CHANGE_RANGE) {
            updateBodyBackgroundColor(Math.max(0, Math.min(1, scrollDistance / COLOR_CHANGE_RANGE)));
            showComments(0);
            if (scrollDistance < 0) hasTriggered = false;
        } else {
            updateBodyBackgroundColor(1);
            showComments(Math.max(0, Math.min(1, (scrollDistance - COLOR_CHANGE_RANGE) / COMMENT_SHOW_RANGE)));
        }
    }

    window.addEventListener('scroll', handleScroll);
    document.body.style.transition = 'background-color 0.05s linear';
    commentsContent.style.opacity = '0';
    commentsContent.style.transform = 'translateY(50px)';
    commentsContent.style.transition = 'opacity 0.05s linear, transform 0.05s linear';
    footer.style.transition = 'color 0.05s linear';
    updateBodyBackgroundColor(0);
    showComments(0);
})();

// 粒子系统
(function() {
    const bg = document.getElementById('particlesBackground');
    const fg = document.getElementById('particlesForeground');
    function createParticle(container, isForeground) {
        const p = document.createElement('div');
        p.className = 'particle';
        const size = Math.random() * (isForeground ? 8 : 9) + (isForeground ? 8 : 3);
        p.style.width = size + 'px';
        p.style.height = size + 'px';
        p.style.left = Math.random() * 100 + '%';
        const duration = isForeground ? Math.random() * 10 + 8 : Math.random() * 15 + 12;
        p.style.animationDuration = duration + 's';
        const delay = Math.random() * 5;
        p.style.animationDelay = delay + 's';
        p.style.setProperty('--drift', (Math.random() - 0.5) * (isForeground ? 150 : 80) + 'px');
        container.appendChild(p);
        setTimeout(() => p.remove(), (duration + delay) * 1000);
    }
    for (let i = 0; i < 20; i++) setTimeout(() => createParticle(bg, false), i * 250);
    for (let i = 0; i < 10; i++) setTimeout(() => createParticle(fg, true), i * 300);
    setInterval(() => createParticle(bg, false), 2000);
    setInterval(() => createParticle(fg, true), 3000);
})();

// Waline评论系统 [修复版]
(function() {
    let allCommentsFlat = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadComments();
        document.getElementById('commentForm').addEventListener('submit', handleSubmit);
        document.getElementById('cancelReplyBtn').addEventListener('click', cancelReply);
        const savedName = localStorage.getItem('podevus_comment_name');
        const savedEmail = localStorage.getItem('podevus_comment_email');
        const savedWebsite = localStorage.getItem('podevus_comment_website');
        if (savedName) document.getElementById('nameInput').value = savedName;
        if (savedEmail) document.getElementById('emailInput').value = savedEmail;
        if (savedWebsite) document.getElementById('websiteInput').value = savedWebsite;
    });

    function parseDate(item) {
        const raw = item.insertedAt || item.createdAt || item.updatedAt || item.time || item.created;
        if (!raw) return new Date();
        if (typeof raw === 'number') return new Date(raw);
        if (typeof raw === 'string') {
            let safe = raw.replace(' ', 'T').replace(/-/g, '/');
            const d = new Date(safe);
            return isNaN(d.getTime()) ? new Date() : d;
        }
        return new Date();
    }

    function flattenComments(comments, result = []) {
        if (!Array.isArray(comments)) return result;
        comments.forEach(comment => {
            result.push(comment);
            if (comment.children && comment.children.length > 0) {
                flattenComments(comment.children, result);
            }
        });
        return result;
    }

    async function loadComments() {
        const list = document.getElementById('commentsList');
        const count = document.getElementById('commentsCount');
        
        console.log('[API] Fetching comments for path:', PAGE_PATH);
        
        try {
            const res = await fetch(`${WALINE_SERVER_URL}/comment?path=${encodeURIComponent(PAGE_PATH)}&pageSize=100`);
            const data = await res.json();
            
            console.log('[API] Response:', data);
            
            let rootComments = [];
            let totalCount = 0;

            if (data && Array.isArray(data.data)) {
                rootComments = data.data;
                totalCount = data.count || rootComments.length;
            } else if (Array.isArray(data)) {
                rootComments = data;
                totalCount = rootComments.length;
            }
            
            console.log('[API] Root comments:', rootComments.length, 'Total count:', totalCount);
            
            allCommentsFlat = flattenComments(rootComments);
            count.textContent = `${totalCount} Replies`;
            
            if (rootComments.length === 0) {
                list.innerHTML = '<div class="no-comments">You could be the first one</div>';
                return;
            }
            
            rootComments.sort((a, b) => parseDate(b) - parseDate(a));
            list.innerHTML = rootComments.map(c => renderComment(c)).join('');
            bindReplyButtons();
        } catch (e) {
            console.error('[API] Failed:', e);
            list.innerHTML = '<div class="no-comments">Failed to load comments.</div>';
        }
    }

    function getCommentNick(comment) {
        if (!comment) return 'Anonymous';
        if (comment.nick && String(comment.nick).trim()) return comment.nick;
        if (comment.user && comment.user.nick && String(comment.user.nick).trim()) return comment.user.nick;
        return 'Anonymous';
    }

    function renderComment(c, depth = 0) {
        const avatar = c.avatar || `https://www.gravatar.com/avatar/${c.mail_md5 || ''}?s=45&d=mm&r=g`;
        const nickName = getCommentNick(c);
        let author = c.link ? `<a href="${escapeHtml(c.link)}" target="_blank" rel="nofollow noopener">${escapeHtml(nickName)}</a>` : escapeHtml(nickName);
        
        let replyInd = '';
        if (c.pid) {
            const parent = allCommentsFlat.find(x => String(x.objectId) === String(c.pid));
            if (parent) {
                const pName = getCommentNick(parent);
                replyInd = `<div class="reply-to-indicator">Reply to <span>@${escapeHtml(pName)}</span></div>`;
            }
        }
        
        let replies = '';
        if (c.children && c.children.length > 0) {
            const sortedChildren = [...c.children].sort((a,b) => parseDate(a) - parseDate(b));
            replies = `<div class="comment-replies">${sortedChildren.map(r => renderComment(r, Math.min(depth+1, 3))).join('')}</div>`;
        }
        
        const timeStr = formatTime(parseDate(c));
        
        return `<div class="comment-card" id="comment-${c.objectId}"><div class="comment-header"><div class="comment-header-left"><div class="comment-avatar"><img src="${avatar}" alt="${escapeHtml(nickName)}" loading="lazy"></div><div class="comment-author-info"><span class="comment-author">${author}</span><span class="comment-time"><a href="#comment-${c.objectId}">${timeStr}</a></span></div></div></div>${replyInd}<div class="comment-content">${c.comment}</div><div class="comment-footer"><button class="reply-btn" data-comment-id="${c.objectId}" data-root-id="${c.rid || c.objectId}" data-author="${escapeHtml(nickName)}">Reply</button></div></div>${replies}`;
    }

    function bindReplyButtons() {
        document.querySelectorAll('.reply-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                setReplyTo(this.dataset.commentId, this.dataset.rootId, this.dataset.author);
            });
        });
    }

    function setReplyTo(id, rootId, author) {
        document.getElementById('replyToId').value = id;
        document.getElementById('replyToAuthor').value = rootId;
        document.getElementById('replyToName').textContent = author;
        document.getElementById('replyNotice').classList.remove('hidden');
        document.getElementById('respond').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('commentTextarea').focus();
    }

    function cancelReply() {
        document.getElementById('replyToId').value = '';
        document.getElementById('replyToAuthor').value = '';
        document.getElementById('replyNotice').classList.add('hidden');
    }
    window.cancelReply = cancelReply;

    async function handleSubmit(e) {
        e.preventDefault();
        const name = document.getElementById('nameInput').value.trim();
        const email = document.getElementById('emailInput').value.trim();
        const website = document.getElementById('websiteInput').value.trim();
        const content = document.getElementById('commentTextarea').value.trim();
        const replyToId = document.getElementById('replyToId').value;
        const rootId = document.getElementById('replyToAuthor').value;
        const msg = document.getElementById('formMessage');
        const btn = document.getElementById('submitBtn');
        
        if (!name || !email || !content) { showMessage(msg, 'Please fill in all required fields', 'error'); return; }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showMessage(msg, 'Please enter a valid email', 'error'); return; }
        if (website && !isValidUrl(website)) { showMessage(msg, 'Please enter a valid URL', 'error'); return; }
        if (content.length > 1000) { showMessage(msg, 'Comment too long', 'error'); return; }
        
        localStorage.setItem('podevus_comment_name', name);
        localStorage.setItem('podevus_comment_email', email);
        if (website) localStorage.setItem('podevus_comment_website', website);
        
        btn.disabled = true;
        btn.textContent = 'Posting...';
        
        try {
            const data = {
                comment: content,
                nick: name,
                mail: email,
                link: website || '',
                path: PAGE_PATH,
                url: window.location.href,
                ua: navigator.userAgent
            };
            
            if (replyToId) {
                data.pid = replyToId;
                data.rid = rootId || replyToId;
                const parent = allCommentsFlat.find(c => String(c.objectId) === String(replyToId));
                data.at = parent ? getCommentNick(parent) : 'Anonymous';
            }
            
            console.log('[Submit] Comment data:', data);
            
            const res = await fetch(`${WALINE_SERVER_URL}/comment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            console.log('[Submit] Response:', result);
            
            if (result.errno === 0 || result.data) {
                document.getElementById('commentTextarea').value = '';
                cancelReply();
                showMessage(msg, 'Comment posted!', 'success');
                setTimeout(() => msg.classList.add('hidden'), 3000);
                await loadComments();
            } else {
                showMessage(msg, result.errmsg || 'Failed', 'error');
            }
        } catch (err) {
            console.error('[Submit] Failed:', err);
            showMessage(msg, 'Failed to post', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Post Comment';
        }
    }

    function formatTime(ts) {
        if (isNaN(ts.getTime())) return 'Unknown Date';
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        let h = ts.getHours();
        const ampm = h >= 12 ? 'pm' : 'am';
        h = h % 12 || 12;
        return `${months[ts.getMonth()]} ${ts.getDate()}, ${ts.getFullYear()} at ${h}:${ts.getMinutes().toString().padStart(2,'0')} ${ampm}`;
    }
    
    function isValidUrl(u) { try { new URL(u); return true; } catch { return false; } }
    function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function showMessage(el, m, type) { el.textContent = m; el.className = 'message ' + type; el.classList.remove('hidden'); }
})();

window.addEventListener('load', () => {
    document.body.style.opacity = '0';
    setTimeout(() => { document.body.style.transition = 'opacity 0.5s ease'; document.body.style.opacity = '1'; }, 100);
});
    </script>
    <script src="../assets/music-player.js"></script>
</body>
</html>